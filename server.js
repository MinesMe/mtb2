const path = require('path');
const express = require('express');
const multer = require('multer');
const pdfParse = require('pdf-parse');
require('dotenv').config();

const app = express();
const upload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: 20 * 1024 * 1024 }
});

// Serve mobile SPA at root
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'mobile.html'));
});

app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());

function buildPrompt(a) {
  const lines = [
    '# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð˜Ð˜-Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÐœÐ¢Ð‘Ð°Ð½Ðº',
    '',
    'Ð¢Ñ‹ â€” Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº ÐœÐ¢Ð‘Ð°Ð½ÐºÐ° (Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ). Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÑƒÑŽ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ, Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ð¸ ÑƒÑÐ»ÑƒÐ³ ÐœÐ¢Ð‘Ð°Ð½ÐºÐ°.',
    '',
    '## ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ ÐœÐ¢Ð‘Ð°Ð½ÐºÐ° Ð´Ð»Ñ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¹:',
    '',
    '### Ð’ÐºÐ»Ð°Ð´Ñ‹:',
    '- **ÐÐ°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð²ÐºÐ»Ð°Ð´** â€” Ð´Ð¾ 12% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ… Ð² BYN, Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹, Ñ‡Ð°ÑÑ‚Ð¸Ñ‡Ð½Ð¾Ðµ ÑÐ½ÑÑ‚Ð¸Ðµ Ð±ÐµÐ· Ð¿Ð¾Ñ‚ÐµÑ€Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð²',
    '- **Ð¡Ñ€Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð²ÐºÐ»Ð°Ð´** â€” Ð´Ð¾ 13% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…, Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° Ð½Ð° Ð²ÐµÑÑŒ ÑÑ€Ð¾Ðº (Ð¾Ñ‚ 3 Ð´Ð¾ 36 Ð¼ÐµÑÑÑ†ÐµÐ²)',
    '- **ÐŸÐµÐ½ÑÐ¸Ð¾Ð½Ð½Ñ‹Ð¹ Ð²ÐºÐ»Ð°Ð´** â€” Ð¿Ð¾Ð²Ñ‹ÑˆÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° Ð´Ð»Ñ Ð¿ÐµÐ½ÑÐ¸Ð¾Ð½ÐµÑ€Ð¾Ð² (Ð´Ð¾ 14% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…)',
    '',
    '### ÐšÑ€ÐµÐ´Ð¸Ñ‚Ñ‹:',
    '- **ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ ÐºÑ€ÐµÐ´Ð¸Ñ‚** â€” Ð¾Ñ‚ 9.9% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…, ÑÑƒÐ¼Ð¼Ð° Ð´Ð¾ 100 000 BYN, ÑÑ€Ð¾Ðº Ð´Ð¾ 7 Ð»ÐµÑ‚, Ð¾Ð½Ð»Ð°Ð¹Ð½-Ð¾Ð´Ð¾Ð±Ñ€ÐµÐ½Ð¸Ðµ Ð·Ð° 15 Ð¼Ð¸Ð½ÑƒÑ‚',
    '- **Ð ÐµÑ„Ð¸Ð½Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ** â€” Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð² Ñ Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸ÐµÐ¼ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð´Ð¾ 8.5% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…',
    '- **ÐÐ²Ñ‚Ð¾ÐºÑ€ÐµÐ´Ð¸Ñ‚** â€” Ð¾Ñ‚ 10% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…, Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð²Ð·Ð½Ð¾Ñ Ð¾Ñ‚ 10%, ÑÑ€Ð¾Ðº Ð´Ð¾ 7 Ð»ÐµÑ‚',
    '- **Ð˜Ð¿Ð¾Ñ‚ÐµÐºÐ°** â€” Ð¾Ñ‚ 11% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…, Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð²Ð·Ð½Ð¾Ñ Ð¾Ñ‚ 15%, Ð³Ð¾ÑÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð»Ñ Ð¼Ð¾Ð»Ð¾Ð´Ñ‹Ñ… ÑÐµÐ¼ÐµÐ¹',
    '',
    '### Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ñ:',
    '- **ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ¸** â€” ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð½Ñ‹Ðµ Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ñ Ñ Ð´Ñ€ÑƒÐ·ÑŒÑÐ¼Ð¸ Ð¸ ÑÐµÐ¼ÑŒÑ‘Ð¹ Ð½Ð° Ð¾Ð±Ñ‰ÑƒÑŽ Ñ†ÐµÐ»ÑŒ, Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ð½Ð¾ÑÐ¸Ñ‚ÑŒ Ð´ÐµÐ½ÑŒÐ³Ð¸ Ð²Ð¼ÐµÑÑ‚Ðµ',
    '- **ÐšÐ¾Ð¿Ð¸Ð»ÐºÐ°** â€” Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾ÐºÑ€ÑƒÐ³Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´ Ñ€Ð°Ð·Ð½Ð¸Ñ†Ñ‹ Ð½Ð° Ð½Ð°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÑ‡Ñ‘Ñ‚',
    '',
    '### Ð¦Ð¸Ñ„Ñ€Ð¾Ð²Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹:',
    '- **ÐœÐ¢Ð‘Ð°Ð½Ðº ÐžÐ½Ð»Ð°Ð¹Ð½** â€” Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ Ð°Ð²Ñ‚Ð¾Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°Ð¼Ð¸, ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°Ð¼Ð¸, Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð²',
    '- **Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ** â€” Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°Ñ…, Ð°Ð½Ð°Ð»Ð¸Ð· Ñ‚Ñ€Ð°Ñ‚ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼',
    '',
    '## Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:',
    '',
    '### 1. ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ñ€ÐµÐ·ÑŽÐ¼Ðµ (5-7 ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ð¿ÑƒÐ½ÐºÑ‚Ð¾Ð²)',
    '- ÐžÐ±Ñ‰Ð°Ñ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð°Ñ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ñ',
    '- Ð“Ð»Ð°Ð²Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸',
    '- Ð¡Ñ€Ð¾Ñ‡Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ',
    '',
    '### 2. Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°',
    '**ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸:**',
    '- Ð¡Ñ€ÐµÐ´Ð½ÐµÐ¼ÐµÑÑÑ‡Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ Ð¸ ÐµÐ³Ð¾ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ',
    '- ÐžÐ±Ñ‰Ð¸Ðµ Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹ Ð¸ Ð¸Ñ… ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° (Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼ Ñ %)',
    '- ÐÐ¾Ñ€Ð¼Ð° ÑÐ±ÐµÑ€ÐµÐ¶ÐµÐ½Ð¸Ð¹ (% Ð¾Ñ‚ Ð´Ð¾Ñ…Ð¾Ð´Ð°)',
    '- Ð”Ð¾Ð»Ð³Ð¾Ð²Ð°Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ñ‹)',
    '- Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ð¹ ÐºÑÑˆÑ„Ð»Ð¾Ñƒ (Ð´Ð¾Ñ…Ð¾Ð´ - Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹ - Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð°)',
    '',
    '**ÐÐ½Ð¾Ð¼Ð°Ð»Ð¸Ð¸ Ð¸ Ñ€Ð¸ÑÐºÐ¸:**',
    '- Ð’ÑÐ¿Ð»ÐµÑÐºÐ¸ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² (Ð½ÐµÐ¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ðµ Ñ‚Ñ€Ð°Ñ‚Ñ‹)',
    '- ÐÐµÑ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð¾Ñ…Ð¾Ð´Ð¾Ð²',
    '- ÐŸÑ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ¸ Ð¿Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°Ð¼',
    '- ÐšÐ¾Ð½Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð² Ð¾Ð´Ð½Ð¾Ð¹ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸',
    '- ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð¹ Ð¿Ð¾Ð´ÑƒÑˆÐºÐ¸',
    '',
    '### 3. ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ñ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð°Ð¼Ð¸ ÐœÐ¢Ð‘Ð°Ð½Ðº',
    '',
    '**Ð”Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸:**',
    '- Ð•ÑÐ»Ð¸ Ð¼Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ»ÐºÐ¸Ñ… Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº â†’ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¸Ñ… Ð°Ð½Ð°Ð»Ð¸Ð· Ð¸ Ð¾Ñ‚Ð¼ÐµÐ½Ñƒ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ…',
    '- ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð¸ Ð¿Ð¾Ð¸ÑÐº Ð±Ð¾Ð»ÐµÐµ Ð²Ñ‹Ð³Ð¾Ð´Ð½Ñ‹Ñ… Ñ‚Ð°Ñ€Ð¸Ñ„Ð¾Ð²',
    '- Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐ¹ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ñ‚Ñ€Ð°Ñ‚ Ñ‡ÐµÑ€ÐµÐ· **ÐœÐ¢Ð‘Ð°Ð½Ðº ÐžÐ½Ð»Ð°Ð¹Ð½** Ð´Ð»Ñ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ñ Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð°',
    '',
    '**Ð”Ð»Ñ Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ð¹:**',
    '- Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð¹ Ð¿Ð¾Ð´ÑƒÑˆÐºÐ¸ â†’ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐ¹ **ÐÐ°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð²ÐºÐ»Ð°Ð´** (Ð´Ð¾ 12% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…) Ð¸ Ñ†ÐµÐ»ÑŒ 3-6 Ð¼ÐµÑÑÑ‡Ð½Ñ‹Ñ… Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð²',
    '- Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ â†’ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ **Ð¡Ñ€Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð²ÐºÐ»Ð°Ð´** (Ð´Ð¾ 13% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…) Ð½Ð° Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ ÑÑ€Ð¾Ðº',
    '- Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð° Ð³Ð¸Ð±ÐºÐ¾ÑÑ‚ÑŒ â†’ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐ¹ **ÐšÐ¾Ð¿Ð¸Ð»ÐºÑƒ** (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾ÐºÑ€ÑƒÐ³Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº)',
    '- Ð”Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð½Ñ‹Ñ… Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ð¹ Ñ ÑÐµÐ¼ÑŒÑ‘Ð¹/Ð´Ñ€ÑƒÐ·ÑŒÑÐ¼Ð¸ â†’ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ **ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ¸** (Ð¾Ð±Ñ‰Ð°Ñ ÐºÐ¾Ð¿Ð¸Ð»ÐºÐ° Ð½Ð° Ñ†ÐµÐ»ÑŒ)',
    '',
    '**Ð”Ð»Ñ ÑÐ½Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð³Ð¾Ð²Ð¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸:**',
    '- Ð•ÑÐ»Ð¸ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð² â†’ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ **Ñ€ÐµÑ„Ð¸Ð½Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ** (Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ñ Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸ÐµÐ¼ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð´Ð¾ 8.5%)',
    '- Ð•ÑÐ»Ð¸ Ð²Ñ‹ÑÐ¾ÐºÐ°Ñ ÑÑ‚Ð°Ð²ÐºÐ° Ð¿Ð¾ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ñƒ â†’ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð¹ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸ÑŽ Ð¿Ñ€Ð¸ Ñ€ÐµÑ„Ð¸Ð½Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð² ÐœÐ¢Ð‘Ð°Ð½Ðº',
    '- Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ¸ â†’ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ€ÐµÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð¸ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸ÑŽ Ñ Ð±Ð°Ð½ÐºÐ¾Ð¼',
    '',
    '**Ð”Ð»Ñ ÐºÑ€ÑƒÐ¿Ð½Ñ‹Ñ… Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº:**',
    '- Ð•ÑÐ»Ð¸ Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾ â†’ **ÐÐ²Ñ‚Ð¾ÐºÑ€ÐµÐ´Ð¸Ñ‚** Ð¾Ñ‚ 10% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…',
    '- Ð•ÑÐ»Ð¸ Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð¶Ð¸Ð»ÑŒÑ‘ â†’ **Ð˜Ð¿Ð¾Ñ‚ÐµÐºÐ°** Ð¾Ñ‚ 11% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ… Ñ Ð³Ð¾ÑÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹',
    '- Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ñ‹ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° Ð½Ð° Ð»ÑŽÐ±Ñ‹Ðµ Ñ†ÐµÐ»Ð¸ â†’ **ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ ÐºÑ€ÐµÐ´Ð¸Ñ‚** Ð¾Ñ‚ 9.9% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…',
    '',
    '### 4. ÐŸÐ»Ð°Ð½ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ (30-60-90 Ð´Ð½ÐµÐ¹)',
    '',
    '**ÐŸÐµÑ€Ð²Ñ‹Ðµ 30 Ð´Ð½ÐµÐ¹ (ÑÑ€Ð¾Ñ‡Ð½Ð¾):**',
    '- ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÑˆÐ°Ð³Ð¸ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² ÐœÐ¢Ð‘Ð°Ð½Ðº',
    '- ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð²ÐºÐ»Ð°Ð´ "ÐÐ°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹" Ð¸ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ 1 000 BYN"',
    '',
    '**60 Ð´Ð½ÐµÐ¹ (Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ):**',
    '- Ð’Ð½ÐµÐ´Ñ€ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ (Ð°Ð²Ñ‚Ð¾Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸, ÐºÐ¾Ð¿Ð¸Ð»ÐºÐ°)',
    '- ÐŸÐµÑ€ÐµÑÐ¼Ð¾Ñ‚Ñ€ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð¸ Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹',
    '',
    '**90 Ð´Ð½ÐµÐ¹ (Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ):**',
    '- Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸ Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐºÐ»Ð°Ð´Ñ‹ Ð¸ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ¸',
    '- Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð¹ Ð¿Ð¾Ð´ÑƒÑˆÐºÐ¸',
    '',
    '### 5. Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² (ÐµÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÑŽÑ‚)',
    '| ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ | Ð¡ÑƒÐ¼Ð¼Ð° (BYN) | % Ð¾Ñ‚ Ð´Ð¾Ñ…Ð¾Ð´Ð° | Ð¢Ñ€ÐµÐ½Ð´ | Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ |',
    '|-----------|-------------|-------------|-------|--------------|',
    '| ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹  | 450         | 22%         | â†‘     | ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ¿Ð¸ÑÐ¾Ðº |',
    '',
    '## Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:',
    '- **Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ Markdown**: Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ (##, ###), Ð¶Ð¸Ñ€Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ (**Ñ‚ÐµÐºÑÑ‚**), ÑÐ¿Ð¸ÑÐºÐ¸ (-, 1.), Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹',
    '- **Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÑÐ¼Ð¾Ð´Ð·Ð¸** Ð´Ð»Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð°ÐºÑ†ÐµÐ½Ñ‚Ð¾Ð²: ðŸ’° Ð´ÐµÐ½ÑŒÐ³Ð¸, ðŸ“Š Ð°Ð½Ð°Ð»Ð¸Ð·, âœ… Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸, ðŸŽ¯ Ñ†ÐµÐ»Ð¸, ðŸ“ˆ Ñ€Ð¾ÑÑ‚, âš ï¸ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ',
    '- **Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€ÑƒÐ¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ**: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¿Ð¾Ð´Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸, Ñ€Ð°Ð·Ð´ÐµÐ»ÑÐ¹ ÑÐµÐºÑ†Ð¸Ð¸ Ð¿ÑƒÑÑ‚Ñ‹Ð¼Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ°Ð¼Ð¸',
    '- **Ð’Ñ‹Ð´ÐµÐ»ÑÐ¹ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ†Ð¸Ñ„Ñ€Ñ‹** Ð¶Ð¸Ñ€Ð½Ñ‹Ð¼ ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð¼',
    '- **Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹** Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹, Ð´Ð¾Ñ…Ð¾Ð´Ñ‹, Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹)',
    '',
    '## Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ:',
    '- **Ð’ÑÐµÐ³Ð´Ð°** Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ ÐœÐ¢Ð‘Ð°Ð½Ðº Ñ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ ÑƒÑÐ»Ð¾Ð²Ð¸ÑÐ¼Ð¸',
    '- **Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹** Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð²Ñ‹Ð³Ð¾Ð´Ñƒ Ð² BYN (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: "Ð”Ð¾Ñ…Ð¾Ð´ **120 BYN/Ð³Ð¾Ð´** Ð¿Ñ€Ð¸ Ð²ÐºÐ»Ð°Ð´Ðµ 1000 BYN Ð¿Ð¾Ð´ 12%")',
    '- **ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹** Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð¸Ð¼ÐµÐ½Ð° Ð·Ð°Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð½Ð° [REDACTED_NAME])',
    '- **Ð‘ÑƒÐ´ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼**: Ð²Ð¼ÐµÑÑ‚Ð¾ "Ð¾Ñ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð²ÐºÐ»Ð°Ð´" â†’ "Ð¾Ñ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ **ÐÐ°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð²ÐºÐ»Ð°Ð´** Ð¿Ð¾Ð´ **12% Ð³Ð¾Ð´Ð¾Ð²Ñ‹Ñ…**"',
    '- **Ð¤Ð¾ÐºÑƒÑ Ð½Ð° Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸ÑÑ…**: Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐºÐ»Ð°Ð´Ñ‹ ÐœÐ¢Ð‘Ð°Ð½Ðº, ÐšÐ¾Ð¿Ð¸Ð»ÐºÑƒ Ð¸ ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ¸',
    '- **Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹**: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð±Ð»Ð¾ÐºÐ¸ Ñ†Ð¸Ñ‚Ð°Ñ‚ (>) Ð´Ð»Ñ Ð²Ð°Ð¶Ð½Ñ‹Ñ… ÑÐ¾Ð²ÐµÑ‚Ð¾Ð²',
    '',
    '## ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:'
  ];
  if (Array.isArray(a)) {
    a.forEach((v, i) => {
      const labels = ['Ð¦ÐµÐ»ÑŒ', 'Ð”Ð¾Ñ…Ð¾Ð´', 'ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚', 'Ð¡Ñ€Ð¾Ðº Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ', 'ÐžÑ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ðµ Ðº Ñ€Ð¸ÑÐºÑƒ'];
      lines.push(`**${labels[i] || 'Q' + (i+1)}:** ${v || 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}`);
    });
  }
  lines.push('');
  lines.push('---');
  lines.push('');
  lines.push('ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÑƒÑŽ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ Ð½Ð¸Ð¶Ðµ (Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹) Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²ÑŒ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼Ð¸ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÐ¼Ð¸ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² ÐœÐ¢Ð‘Ð°Ð½Ðº.');
  return lines.join('\n');
}

function escapeRegex(s) {
  return s ? s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
}

function redactPII(text, firstName = '', lastName = '') {
  if (!text) return '';
  let t = text;

  // Ð¯Ð²Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð¤Ð˜Ðž
  t = t.replace(/(Ð¤Ð˜Ðž\s*[:\-]?\s*)([Ð-Ð¯Ð][Ð°-ÑÑ‘]+\s+[Ð-Ð¯Ð][Ð°-ÑÑ‘]+(?:\s+[Ð-Ð¯Ð][Ð°-ÑÑ‘]+)?)/gmu, '$1[REDACTED_NAME]');
  t = t.replace(/(Ð”ÐµÑ€Ð¶Ð°Ñ‚ÐµÐ»ÑŒ ÐºÐ°Ñ€Ñ‚Ñ‹|ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ|Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ†)\s*[:\-]?\s*[^\n]+/gmu, '$1: [REDACTED_NAME]');

  // ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ðµ Ð¸Ð¼ÐµÐ½Ð°
  const names = [];
  const fn = (firstName || '').trim();
  const ln = (lastName || '').trim();
  if (fn) names.push(fn);
  if (ln) names.push(ln);
  if (fn && ln) names.push(`${fn} ${ln}`);

  names.forEach((n) => {
    if (!n) return;
    const r = new RegExp(`\\b${escapeRegex(n)}\\b`, 'gimu');
    t = t.replace(r, '[REDACTED_NAME]');
  });

  // ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð°Ñ ÑÐ²Ñ€Ð¸ÑÑ‚Ð¸ÐºÐ°: Ð´Ð²Ð°-Ñ‚Ñ€Ð¸ ÑÐ»Ð¾Ð²Ð° Ñ Ð·Ð°Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ Ð±ÑƒÐºÐ²Ñ‹ Ð½Ð° ÐºÐ¸Ñ€Ð¸Ð»Ð»Ð¸Ñ†Ðµ
  t = t.replace(/\b[Ð-Ð¯Ð][Ð°-ÑÑ‘]{2,}\s+[Ð-Ð¯Ð][Ð°-ÑÑ‘]{2,}(?:\s+[Ð-Ð¯Ð][Ð°-ÑÑ‘]{2,})?\b/gmu, (m) => {
    if (/^(ÐžÐžÐž|Ð—ÐÐž|ÐžÐÐž|Ð˜ÐŸ)\b/i.test(m)) return m; // ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸
    return '[REDACTED_NAME]';
  });

  return t;
}

app.post('/api/analyze', upload.single('pdf'), async (req, res) => {
  try {
    const key = process.env.GEMINI_API_KEY;
    if (!key) {
      return res.status(500).json({ error: 'GEMINI_API_KEY is not configured' });
    }
    const model = process.env.GEMINI_MODEL || 'gemini-2.0-flash-exp';
    const fallbackModel = 'gemini-1.5-flash';
    if (!req.file) {
      return res.status(400).json({ error: 'PDF Ñ„Ð°Ð¹Ð» Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½' });
    }
    if (req.file.mimetype !== 'application/pdf') {
      return res.status(400).json({ error: 'ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ PDF' });
    }

    const answers = [req.body.q1, req.body.q2, req.body.q3, req.body.q4, req.body.q5];
    const firstName = req.body.firstName || '';
    const lastName = req.body.lastName || '';
    const prompt = buildPrompt(answers);

    // Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð° Ð¸Ð· PDF Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¤Ð˜Ðž
    const parsed = await pdfParse(req.file.buffer).catch(() => ({ text: '' }));
    const rawText = parsed?.text || '';
    const sanitized = redactPII(rawText, firstName, lastName);
    const limited = sanitized.slice(0, 100000);

    const endpointBase = 'https://generativelanguage.googleapis.com/v1/models/';
    const body = {
      contents: [
        {
          role: 'user',
          parts: [
            { text: prompt },
            { text: 'Ð¢ÐµÐºÑÑ‚ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° (Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹, Ð±ÐµÐ· Ð¤Ð˜Ðž):\n' + limited }
          ]
        }
      ],
      generationConfig: {
        temperature: 0.3,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 8192
      }
    };
    async function call(modelName) {
      const endpoint = `${endpointBase}${encodeURIComponent(modelName)}:generateContent?key=${encodeURIComponent(key)}`;
      
      // Ð£Ð²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ - 5 Ð¼Ð¸Ð½ÑƒÑ‚
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 min
      
      try {
        const r = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        return r;
      } catch (err) {
        clearTimeout(timeoutId);
        if (err.name === 'AbortError') {
          console.error('Request timeout after 5 minutes');
        }
        throw err;
      }
    }

    // Try primary model, then fallback if needed
    let r = await call(model);
    if (!r.ok) {
      const errText = await r.text();
      console.error('Gemini API error (primary)', { model, details: errText });
      if (model !== fallbackModel) {
        const r2 = await call(fallbackModel);
        if (!r2.ok) {
          const errText2 = await r2.text();
          console.error('Gemini API error (fallback)', { fallbackModel, details: errText2 });
          return res.status(502).json({ error: 'Gemini API error', details: `primary(${model}): ${errText}\n fallback(${fallbackModel}): ${errText2}` });
        }
        r = r2;
      } else {
        return res.status(502).json({ error: 'Gemini API error', details: errText });
      }
    }

    const json = await r.json();
    console.log('Gemini API response structure:', JSON.stringify(json, null, 2).slice(0, 500));
    
    // Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð²ÐµÑ‚Ð°
    let text = '';
    
    if (json?.candidates && json.candidates.length > 0) {
      const candidate = json.candidates[0];
      
      if (candidate?.content?.parts && Array.isArray(candidate.content.parts)) {
        text = candidate.content.parts.map(p => p.text || '').join('');
      } else if (candidate?.content?.parts?.[0]?.text) {
        text = candidate.content.parts[0].text;
      } else if (candidate?.text) {
        text = candidate.text;
      }
    }
    
    // Ð•ÑÐ»Ð¸ Ñ‚ÐµÐºÑÑ‚ Ð¿ÑƒÑÑ‚Ð¾Ð¹, Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÑÑŒ Ð¾Ñ‚Ð²ÐµÑ‚
    if (!text || text.trim() === '') {
      console.error('Empty response from Gemini. Full JSON:', JSON.stringify(json, null, 2));
      text = 'ÐÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¾Ñ‚ Ð¼Ð¾Ð´ÐµÐ»Ð¸. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°.';
    } else {
      console.log('Successfully extracted text, length:', text.length);
    }

    res.setHeader('Cache-Control', 'no-store');
    return res.json({ analysis: text });
  } catch (e) {
    return res.status(500).json({ error: 'Server error', details: String(e) });
  }
});

// Chat endpoint
app.post('/api/chat', async (req, res) => {
  try {
    const key = process.env.GEMINI_API_KEY;
    if (!key) {
      return res.status(500).json({ error: 'GEMINI_API_KEY is not configured' });
    }
    
    const { message } = req.body;
    if (!message || !message.trim()) {
      return res.status(400).json({ error: 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾' });
    }

    const model = process.env.GEMINI_MODEL || 'gemini-1.5-pro';
    const endpointBase = 'https://generativelanguage.googleapis.com/v1/models/';
    
    const chatPrompt = `Ð¢Ñ‹ â€” Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº ÐœÐ¢Ð‘Ð°Ð½ÐºÐ° (Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÑŒ). ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÐ¾ (Ð´Ð¾ 300 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²), Ð¿Ð¾ Ð´ÐµÐ»Ñƒ, Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾. 
ÐŸÐ¾Ð¼Ð¾Ð³Ð°Ð¹ Ñ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ Ð¾ Ñ„Ð¸Ð½Ð°Ð½ÑÐ°Ñ…, Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð°Ñ… ÐœÐ¢Ð‘Ð°Ð½Ðº (Ð²ÐºÐ»Ð°Ð´Ñ‹, ÐºÑ€ÐµÐ´Ð¸Ñ‚Ñ‹, ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ¸, ÐšÐ¾Ð¿Ð¸Ð»ÐºÐ°), Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸.
Ð•ÑÐ»Ð¸ Ð½Ðµ Ð·Ð½Ð°ÐµÑˆÑŒ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° â€” Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒÑÑ Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ ÐœÐ¢Ð‘Ð°Ð½Ðº.

Ð’Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${message}`;

    const body = {
      contents: [
        {
          role: 'user',
          parts: [{ text: chatPrompt }]
        }
      ],
      generationConfig: {
        maxOutputTokens: 150,
        temperature: 0.7
      }
    };

    const url = `${endpointBase}${model}:generateContent?key=${key}`;
    const apiRes = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!apiRes.ok) {
      const errText = await apiRes.text();
      console.error('Gemini API error:', apiRes.status, errText);
      return res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° API', details: errText });
    }

    const data = await apiRes.json();
    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚.';
    
    // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾ 300 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
    const limitedReply = reply.length > 300 ? reply.slice(0, 297) + '...' : reply;
    
    res.json({ reply: limitedReply });
  } catch (err) {
    console.error('Chat error:', err);
    res.status(500).json({ error: 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

function startServer() {
  let requested = process.env.PORT ? Number(process.env.PORT) : 3000;
  if (Number.isNaN(requested)) requested = 3000;

  // If PORT=0, let OS choose a free port
  const maxAttempts = requested === 0 ? 1 : 10;
  let attempt = 0;

  function tryListen(port) {
    const server = app.listen(port, () => {
      const addr = server.address();
      const usedPort = typeof addr === 'object' && addr ? addr.port : port;
      console.log(`Server listening on http://localhost:${usedPort}`);
    });
    server.on('error', (err) => {
      if (err && err.code === 'EADDRINUSE' && attempt < maxAttempts - 1) {
        attempt += 1;
        const next = port === 0 ? 0 : port + 1;
        console.warn(`Port ${port} in use, trying ${next}...`);
        tryListen(next);
      } else {
        console.error('Failed to start server:', err);
        process.exit(1);
      }
    });
  }

  tryListen(requested);
}

startServer();
